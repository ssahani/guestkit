name: RPM Build

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-rpm:
    name: Build RPM on ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        os:
          - fedora:39
          - fedora:40
          - fedora:rawhide
        include:
          - os: fedora:39
            version: "39"
          - os: fedora:40
            version: "40"
          - os: fedora:rawhide
            version: "rawhide"
    container:
      image: ${{ matrix.os }}

    steps:
      - name: Install git
        run: |
          dnf install -y git

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install RPM build dependencies
        run: |
          dnf install -y \
            rpm-build \
            rpmdevtools \
            rust \
            cargo \
            gcc \
            make \
            pkgconfig \
            systemd-devel \
            qemu-img \
            rpmlint

      - name: Setup RPM build tree
        run: |
          rpmdev-setuptree

      - name: Extract version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version =' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create source tarball
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git archive --format=tar.gz --prefix=guestkit-${VERSION}/ \
            -o ~/rpmbuild/SOURCES/guestkit-${VERSION}.tar.gz HEAD

      - name: Copy spec file
        run: |
          cp guestkit.spec ~/rpmbuild/SPECS/

      - name: Install build dependencies from spec
        run: |
          dnf builddep -y ~/rpmbuild/SPECS/guestkit.spec

      - name: Build source RPM
        run: |
          rpmbuild -bs ~/rpmbuild/SPECS/guestkit.spec

      - name: Build binary RPM
        run: |
          rpmbuild -bb ~/rpmbuild/SPECS/guestkit.spec

      - name: Run rpmlint on spec
        continue-on-error: true
        run: |
          rpmlint ~/rpmbuild/SPECS/guestkit.spec

      - name: Run rpmlint on RPMs
        continue-on-error: true
        run: |
          rpmlint ~/rpmbuild/RPMS/x86_64/*.rpm

      - name: List built packages
        run: |
          echo "=== Built RPMs ==="
          ls -lh ~/rpmbuild/RPMS/x86_64/
          echo ""
          echo "=== Source RPM ==="
          ls -lh ~/rpmbuild/SRPMS/

      - name: Test installation
        run: |
          dnf install -y ~/rpmbuild/RPMS/x86_64/guestkit-*.rpm

      - name: Test guestctl binary
        run: |
          guestctl --version
          guestctl --help

      - name: Query package info
        run: |
          rpm -qi guestkit
          echo ""
          echo "=== Files installed by package ==="
          rpm -ql guestkit

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-fedora-${{ matrix.version }}-x86_64
          path: |
            ~/rpmbuild/RPMS/x86_64/*.rpm
            ~/rpmbuild/SRPMS/*.rpm
          retention-days: 30

  build-rpm-full:
    name: Build Full RPM with Python on Fedora ${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: [39, 40]
    container:
      image: fedora:${{ matrix.version }}

    steps:
      - name: Install git
        run: |
          dnf install -y git

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install RPM build dependencies
        run: |
          dnf install -y \
            rpm-build \
            rpmdevtools \
            rust \
            cargo \
            gcc \
            make \
            pkgconfig \
            systemd-devel \
            python3-devel \
            python3-pip \
            python3-maturin \
            qemu-img \
            rpmlint

      - name: Setup RPM build tree
        run: |
          rpmdev-setuptree

      - name: Extract version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version =' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create source tarball
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git archive --format=tar.gz --prefix=guestkit-${VERSION}/ \
            -o ~/rpmbuild/SOURCES/guestkit-${VERSION}.tar.gz HEAD

      - name: Copy full spec file
        run: |
          cp guestkit-full.spec ~/rpmbuild/SPECS/

      - name: Install build dependencies from spec
        run: |
          dnf builddep -y ~/rpmbuild/SPECS/guestkit-full.spec

      - name: Build source RPM
        run: |
          rpmbuild -bs ~/rpmbuild/SPECS/guestkit-full.spec

      - name: Build binary RPM (with Python)
        run: |
          rpmbuild -bb ~/rpmbuild/SPECS/guestkit-full.spec

      - name: Run rpmlint
        continue-on-error: true
        run: |
          rpmlint ~/rpmbuild/SPECS/guestkit-full.spec
          rpmlint ~/rpmbuild/RPMS/x86_64/*.rpm

      - name: List built packages
        run: |
          echo "=== Built RPMs ==="
          ls -lh ~/rpmbuild/RPMS/x86_64/
          echo ""
          echo "=== Source RPM ==="
          ls -lh ~/rpmbuild/SRPMS/

      - name: Test installation
        run: |
          dnf install -y ~/rpmbuild/RPMS/x86_64/guestkit-*.rpm \
                         ~/rpmbuild/RPMS/x86_64/python3-guestkit-*.rpm || true

      - name: Test binaries
        run: |
          guestctl --version
          guestctl --help

      - name: Test Python bindings
        continue-on-error: true
        run: |
          python3 -c "import guestkit; print('Python bindings OK')"

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-full-fedora-${{ matrix.version }}-x86_64
          path: |
            ~/rpmbuild/RPMS/x86_64/*.rpm
            ~/rpmbuild/SRPMS/*.rpm
          retention-days: 30

  build-mock:
    name: Build with Mock (clean chroot)
    runs-on: ubuntu-latest
    container:
      image: fedora:39

    steps:
      - name: Install dependencies
        run: |
          dnf install -y git mock rpm-build rpmdevtools

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup RPM build tree
        run: |
          rpmdev-setuptree

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep '^version =' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create source tarball
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git archive --format=tar.gz --prefix=guestkit-${VERSION}/ \
            -o ~/rpmbuild/SOURCES/guestkit-${VERSION}.tar.gz HEAD

      - name: Copy spec file
        run: |
          cp guestkit.spec ~/rpmbuild/SPECS/

      - name: Build SRPM
        run: |
          rpmbuild -bs ~/rpmbuild/SPECS/guestkit.spec

      - name: Initialize Mock
        run: |
          mock --init -r fedora-39-x86_64

      - name: Build with Mock
        run: |
          mock -r fedora-39-x86_64 ~/rpmbuild/SRPMS/guestkit-*.src.rpm

      - name: List Mock results
        run: |
          ls -lh /var/lib/mock/fedora-39-x86_64/result/

      - name: Upload Mock build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-mock-fedora-39-x86_64
          path: /var/lib/mock/fedora-39-x86_64/result/*.rpm
          retention-days: 30

  verify-rpm:
    name: Verify RPM package
    needs: build-rpm
    runs-on: ubuntu-latest
    container:
      image: fedora:39

    steps:
      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-fedora-39-x86_64
          path: ./rpms

      - name: Install dependencies
        run: |
          dnf install -y qemu-img nbd util-linux

      - name: Install RPM
        run: |
          dnf install -y ./rpms/RPMS/x86_64/guestkit-*.rpm

      - name: Verify installation
        run: |
          which guestctl
          guestctl --version

      - name: Check package files
        run: |
          rpm -V guestkit

      - name: Test basic functionality
        run: |
          guestctl --help | grep -q "inspect"
          echo "âœ“ Basic functionality test passed"

  publish-copr:
    name: Publish to COPR (on tags)
    needs: [build-rpm, build-rpm-full]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    container:
      image: fedora:39

    steps:
      - name: Install COPR CLI
        run: |
          dnf install -y copr-cli

      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-fedora-39-x86_64
          path: ./rpms

      - name: Setup COPR config
        env:
          COPR_CONFIG: ${{ secrets.COPR_CONFIG }}
        run: |
          mkdir -p ~/.config
          echo "$COPR_CONFIG" > ~/.config/copr

      - name: Upload to COPR
        run: |
          copr-cli build guestkit ./rpms/SRPMS/guestkit-*.src.rpm

  release-artifacts:
    name: Upload release artifacts
    needs: [build-rpm, build-rpm-full]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Download all RPM artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-rpms

      - name: List artifacts
        run: |
          find ./all-rpms -name "*.rpm" -type f

      - name: Create release archives
        run: |
          cd all-rpms
          for dir in rpm-*; do
            tar czf "${dir}.tar.gz" "$dir"
          done
          ls -lh *.tar.gz

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./all-rpms/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
